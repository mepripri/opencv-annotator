name: Run OpenCV Annotation

on:
  workflow_dispatch:
    inputs:
      image_url:
        description: 'URL of input image to process'
        required: true
      resumeUrl:
        description: 'Optional callback URL from n8n'
        required: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Download input image
        run: |
          curl -L -o input.jpg "${{ github.event.inputs.image_url }}"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run detection
        id: detect
        run: |
          echo "Running detect_boxes.py..."
          JSON_OUTPUT=$(python detect_boxes.py | jq -c .)
          echo "JSON output:"
          echo "$JSON_OUTPUT"

          # Save JSON for GitHub Actions outputs
          echo "json_output=$JSON_OUTPUT" >> $GITHUB_OUTPUT

          # If resumeUrl is provided (from n8n), POST results back
          if [ -n "${{ github.event.inputs.resumeUrl }}" ]; then
            echo "Sending results back to n8n..."
            curl -X POST \
              -H "Content-Type: application/json" \
              -d "$JSON_OUTPUT" \
              "${{ github.event.inputs.resumeUrl }}"
          fi
